##############################################
### ReVesicle - STEP-5 (NPT - Anisotropic) ###
##############################################
# Purpose:
#   Equilibration under anisotropic pressure coupling (fully anisotropic).
#   Lipid headgroups are restrained (consAtomListFile) while the box dimensions
#   and density relax under NPT. 

# Output prefix for this step (NAMD will generate ${outname}.* outputs)
set outname            STEP-5

# CHARMM36m parameter directory (relative path for repo portability)
set dir_ff             ../CHARMM36m

# Trajectory / restart output stride
set dcdfreq            50000

# Energy / pressure print frequency (stdout)
set logfreq            10080

# Print wall-clock timing info every N steps
outputTiming           10080

# Total number of MD steps for STEP-5
set eq_numsteps        1050000


# Target temperature (K)
set temp               310


#############################################################
## ADJUSTABLE PARAMETERS (SYSTEM INPUT / OUTPUT)           ##
#############################################################

# Flag for mesoscale system (use together with .js.inter input)
useCompressedPsf       on

# Input structure + coordinates (from STEP-4 output)
structure              ../STEP-4/STEP-4_empty_holes.js.inter
bincoordinates         ../STEP-4/STEP-4_empty_holes.coor

# Output prefix
outputName             ${outname}

# Set target temperature
temperature            $temp

# Start simulation from step 0
firsttimestep          0

# Set frequency of output (restart, DCD, xst)
restartfreq            $dcdfreq     ;# 5000steps = every 10ps
dcdfreq                $dcdfreq
xstFreq                $dcdfreq

# Energy / pressure output frequency
outputEnergies         $logfreq
outputPressure         $logfreq


##############################################################
### LARGE SCALE SYSTEM PERFORMANCE / MEMORY OPTIMIZED NAMD ###
##############################################################
# Notes:
#   These options are aimed at large systems to reduce memory pressure and/or
#   improve scaling on large core counts. Keep them consistent within a project.

# Pairlists can consume large memory on big systems. This sets a threshold:
# only enable pairlists above a given processor count.
pairlistMinProcs       128

# Pencil decomposition for PME: set 1 for minimal decomposition by default.
pmepencils             1

# PME processors: uses one pencil per node by default.
pmeprocessors          [numNodes]

# Load balancing:
#   "none" disables load balancing (useful if load balancing overhead is large).
ldBalancer             none

# FFTW planning:
#   Use FFTW rules-of-thumb to reduce startup time.
FFTWEstimate           yes

# Parallel I/O settings
numinputprocs          50
numoutputprocs         50

# Topology decomposition tweaks (legacy scaling settings)
twoAwayX               no
twoAwayY               no
twoAwayZ               no

# Pressure barrier synchronization (often used only at extreme scale)
langevinPistonBarrier  off

# References
# Additional information on reducing memory usage may be found at http://www.ks.uiuc.edu/Research/namd/wiki/index.cgi?NamdMemoryReduction
# NAMD Wiki: NamdPerformanceTuning https://www.ks.uiuc.edu/Research/namd/wiki/?NamdPerformanceTuning


##############################################
# FORCE FIELD / CHARMM PARAMETERS (C36m etc.) #
##############################################

paraTypeCharmm         on

# Base CHARMM parameter files
parameters              ${dir_ff}/par_all36m_prot.prm                                          ;# Protein
parameters              ${dir_ff}/par_all36_lipid.prm                                          ;# Lipids
parameters              ${dir_ff}/par_all36_carb.prm                                           ;# Carbohydrates
parameters              ${dir_ff}/par_all36_cgenff.prm                                         ;# Cgenff
parameters              ${dir_ff}/par_all36_na.prm                                             ;# Nucleic

# Additional parameters for water/ions and non-canonical residues
parameters             ${dir_ff}/toppar_water_ions_namd.update.str                             ;# Required for Water and ions
parameters             ${dir_ff}/toppar_all36_lipid_cholesterol.str                            ;# Required for Cholesterol
parameters             ${dir_ff}/toppar_all36_lipid_sphingo.str                                ;# Required for SM Lipids
parameters             ${dir_ff}/toppar_all36_carb_glycolipid.str                              ;# Required for Glycolipids
parameters             ${dir_ff}/toppar_all36_lipid_inositol.str                               ;# Required for PI
parameters             ${dir_ff}/toppar_all36_lipid_miscellaneous.str                          ;# Required for BMGP
parameters             ${dir_ff}/toppar_all36_lipid_cardiolipin.str                            ;# Required for TLCL
parameters             ${dir_ff}/toppar_all36_lipid_ether.str                                  ;# Required for ethers

#############################################
# PERIODIC BOUNDARY CONDITIONS (PBC / CELL) #
#############################################
# Source:
#   Copy/paste values from box_size.txt.

cellBasisVector1       462.953219845 0 0
cellBasisVector2       0 465.952851118 0
cellBasisVector3       0 0 467.734389493
cellOrigin             0.0224990844727 -0.493003845215 0.162002563477


##############################################
# WRAPPING (KEEP SYSTEM CENTERED IN PBC)      #
##############################################

wrapWater              on                            ;# Wrap water molecules only
wrapAll                on                            ;# Wrap all bonded clusters


##############################################
# NONBONDED / INTEGRATOR SETTINGS             #
##############################################

exclude                scaled1-4
1-4scaling             1.0

cutoff                 12.0         ;# Local interaction cutoff (Å)
switching              on           ;# Smooth switching for electrostatics and vdW
switchdist             10.0         ;# Switching distance (cutoff - 2 Å) 
pairlistdist           13.5         ;# Pairlist distance

margin                 4

timestep               2.0          ;# timestep size (fs)
rigidBonds             all          ;# Required for 2 fs timestep with SHAKE on
nonbondedFreq          1
fullElectFrequency     3

# Neighbor list update period:
# Must be a multiple of fullElectFrequency
stepspercycle          21


####################################################
## PME (FULL SYSTEM PERIODIC ELECTROSTATICS)      ###
####################################################

PME                    on
PMEInterpOrder         8
PMEGridSpacing         2.1


#############################################
# TEMPERATURE CONTROL (LANGEVIN THERMOSTAT) #
#############################################
# Constant Temperature Control (NVT thermostat)

langevin               on
langevinDamping        5
langevinTemp           $temp
langevinHydrogen       off


############################################
# PRESSURE CONTROL (FULLY ANISOTROPIC NPT) #
############################################
# This step runs NPT with fully anisotropic box fluctuations.

useGroupPressure       yes                       

useFlexibleCell        yes                       ;# Fully anisotropic when useFlexibleCell = yes amd useConstantArea = no  
useConstantArea        no                        

langevinPiston         on
langevinPistonTarget   1.01325                   ;# Reported in Bar, equivalent to 1 atm 

langevinPistonPeriod   1000
langevinPistonDecay    500
langevinPistonTemp     $temp


###########################
### HARMONIC RESTRAINTS ###
###########################
# Restrain lipid headgroups during anisotropic equilibration.
# consAtomListFile defines the restrained selection/force constants.
# constraintScaling sets the global scale applied to those restraints.

constraints            on
consAtomListFile       ../STEP-4/index_lipid_heads.dat
constraintScaling      10.0


#############################################################
## PROTOCOL / EXECUTION SCRIPT                             ##
#############################################################

# Equilibration / production segment for STEP-5
run                    $eq_numsteps
