##################################################################
## ReVesicle - COMPRESS (standard .js -> compressed .js.inter) ###
##################################################################
# Purpose:
#   Convert a standard NAMD input structure (.js + .coor) into a
#   compressed representation (.js.inter) suitable for all-atom mesoscale
#   simulation and NAMD memory-optimized execution.
#
# Notes:
#   - This job is not a physical equilibration; it runs a single step (run 1)
#     to trigger the generation of the compressed .js.inter output.
#   - The key switch is genCompressedPsf on.
#   - usePluginIO enables reading/writing with plugin-based I/O (required here).

# STEP-1_A input system (set by ReVesicle.sh)
set step1a_base $env(REVESICLE_STEP1A_BASENAME)

#############################################################
## USER-EDITABLE VARIABLES (NO NAMD FLAGS HERE)             ##
#############################################################

# CHARMM36m parameter directory (relative path for repo portability)
set dir_ff ../../CHARMM36m


#############################################################
## ADJUSTABLE PARAMETERS (INPUT / OUTPUT / COMPRESS)        ##
#############################################################

# Enable generation of compressed PSF / .js.inter output
genCompressedPsf        on

# Use plugin I/O for .js / .coor handling
usePluginIO             yes

# Input structure and coordinates (standard, uncompressed)
structure               ${step1a_base}.js
bincoordinates          ${step1a_base}.coor

# Start from step 0
firsttimestep           0

# Temperature variable definition (used below)
set temperature         310

# Output prefix (compressed.* outputs)
outputName              compressed


##############################################################
## SIMULATION PARAMETERS (FORCE FIELD + INTEGRATOR SETTINGS) ##
##############################################################
# This section provides the force-field and runtime settings required for NAMD
# to read the system and write the compressed output consistently.

# Input parameter style
paraTypeCharmm          on

# Enable merging cross terms for CHARMM force field compatibility
mergeCrossterms         yes

# Base CHARMM parameter files
parameters              ${dir_ff}/par_all36m_prot.prm                                          ;# Protein
parameters              ${dir_ff}/par_all36_lipid.prm                                          ;# Lipids
parameters              ${dir_ff}/par_all36_carb.prm                                           ;# Carbohydrates
parameters              ${dir_ff}/par_all36_cgenff.prm                                         ;# Cgenff
parameters              ${dir_ff}/par_all36_na.prm                                             ;# Nucleic

# Additional parameters for water/ions and non-canonical residues
parameters             ${dir_ff}/toppar_water_ions_namd.update.str                             ;# Required for Water and ions
parameters             ${dir_ff}/toppar_all36_lipid_cholesterol.str                            ;# Required for Cholesterol
parameters             ${dir_ff}/toppar_all36_lipid_sphingo.str                                ;# Required for SM Lipids
parameters             ${dir_ff}/toppar_all36_carb_glycolipid.str                              ;# Required for Glycolipids
parameters             ${dir_ff}/toppar_all36_lipid_inositol.str                               ;# Required for PI
parameters             ${dir_ff}/toppar_all36_lipid_miscellaneous.str                          ;# Required for BMGP
parameters             ${dir_ff}/toppar_all36_lipid_cardiolipin.str                            ;# Required for TLCL
parameters             ${dir_ff}/toppar_all36_lipid_ether.str                                  ;# Required for ethers

# Apply thermostat temperature (even though we only run 1 step)
temperature             $temperature


##############################################################
## NONBONDED / INTEGRATOR SETTINGS                           ##
##############################################################

# Force-field exclusions (CHARMM convention)
exclude                 scaled1-4        # Exclusion policy (none, 1-2, 1-3, 1-4, scaled1-4)
                                         # scaled1-4 excludes 1-3 and scales 1-4 interactions.
1-4scaling              1.0              # Scaling factor for 1-4 electrostatics (default 1.0)

# Nonbonded cutoffs (Å)
cutoff                  12.              # Local interaction cutoff
switching               on               # Smooth switching for electrostatics and vdW
switchdist              10.              # Switching distance (cutoff - 2 Å)
pairlistdist            13.5             # Pairlist distance

# Integrator (fs)
timestep                2.0              # timestep size (fs)
rigidBonds              all              # SHAKE for all bonds involving hydrogens (required for 2 fs)
nonbondedFreq           1
fullElectFrequency      3
stepspercycle           21               # Must be a multiple of fullElectFrequency


##############################################################
## PERIODIC BOUNDARY CONDITIONS (PBC / PME)                  ##
##############################################################
# These values should match the system’s periodic cell.
# They are required to keep the system consistent during the compress step.

cellBasisVector1        462.953219845 0 0
cellBasisVector2        0 465.952851118 0
cellBasisVector3        0 0 467.734389493
cellOrigin              0.0224990844727 -0.493003845215 0.162002563477

# Wrap all coordinates into the central unit cell on output
wrapAll                 on               # Wrap all bonded clusters across PBC

# PME electrostatics (required for typical all-atom setups)
PME                     yes
PMEGridSpacing          2.1


##############################################################
## PRESSURE CONTROL                                          ##
##############################################################
# Included for completeness/compatibility; not intended to meaningfully act
# over a single timestep.

useGroupPressure        yes
useFlexibleCell         no
useConstantArea         no


##############################################################
## OUTPUT WRITING OPTIONS                                    ##
##############################################################
# High stride values (effectively no output during the single-step run),
# while still keeping NAMD happy if it expects these options.

restartfreq             999
dcdfreq                 999
xstFreq                 999
outputEnergies          999
outputPressure          999


#############################################################
## EXECUTION SCRIPT                                         ##
#############################################################
# Single step: sufficient to trigger generation of compressed output files.

run 1
