############################
### ReVesicle - STEP-2_A ###
############################
# Purpose:
#   Short restrained MD segment following STEP-1 water/lipid removal.
#   This step uses the mesoscale (.js.inter / .coor) representation and applies
#   harmonic constraints via consAtomListFile to guide equilibration.

# STEP-2_A input system (inherits STEP-1_A basename)
set step1a_base $env(REVESICLE_STEP1A_BASENAME)

# Output prefix for this step (NAMD will generate STEP-2.* outputs)
set outname            STEP-2_A

# CHARMM36m (or CHARMM36*) parameter directory
set dir_ff             ../../CHARMM36m

# Trajectory output stride: 50000 steps = 100 ps (timestep = 2 fs)
set dcdfreq            50000

# Energy / pressure print frequency (stdout)
set logfreq            10080

# Print wall-clock timing info every N steps
outputTiming           10080

# Production/equilibration steps for this STEP-2 segment
set eq_numsteps        367500

# Target temperature (K)
set temp               310


#############################################################
## ADJUSTABLE PARAMETERS (SYSTEM INPUT / OUTPUT)           ##
#############################################################

# Mesoscale system flag (use together with .js.inter input)
useCompressedPsf       on

# System input (intermediate compressed structure + binary coordinates)
structure              ../STEP-1_A/${step1a_base}.js.inter
bincoordinates         ../STEP-1_A/${step1a_base}.coor

# Output file prefix
outputName             ${outname}

# Set the target temperature
temperature            $temp

# Start simulation from step 0
firsttimestep          0

# Set frequency of output (restart, DCD, xst)
restartfreq            $dcdfreq     
dcdfreq                $dcdfreq
xstFreq                $dcdfreq

# Set frequency of output energies
outputEnergies         $logfreq
outputPressure         $logfreq


##############################################################
### LARGE SCALE SYSTEM PERFORMANCE / MEMORY OPTIMIZED NAMD ###
##############################################################
# Notes:
#   These options are aimed at large systems to reduce memory pressure and/or
#   improve scaling on large core counts. Keep them consistent within a project.

# Pairlists can consume large memory on big systems. This sets a threshold:
# only enable pairlists above a given processor count.
pairlistMinProcs       128

# Pencil decomposition for PME: set 1 for minimal decomposition by default.
pmepencils             1

# PME processors: uses one pencil per node by default.
pmeprocessors          [numNodes]

# Load balancing:
#   "none" disables load balancing (useful if load balancing overhead is large).
ldBalancer             none

# FFTW planning:
#   Use FFTW rules-of-thumb to reduce startup time.
FFTWEstimate           yes

# Parallel I/O settings
numinputprocs          50                      
numoutputprocs         50                      

# Topology decomposition tweaks (legacy scaling settings)
twoAwayX               no
twoAwayY               no
twoAwayZ               no

# Pressure barrier synchronization (often used only at extreme scale)
langevinPistonBarrier  off

# References
# Additional information on reducing memory usage may be found at http://www.ks.uiuc.edu/Research/namd/wiki/index.cgi?NamdMemoryReduction
# NAMD Wiki: NamdPerformanceTuning https://www.ks.uiuc.edu/Research/namd/wiki/?NamdPerformanceTuning


##############################################
# FORCE FIELD / CHARMM PARAMETERS (C36m etc.) #
##############################################

paraTypeCharmm         on

# Base CHARMM parameter files
parameters              ${dir_ff}/par_all36m_prot.prm                                          ;# Protein
parameters              ${dir_ff}/par_all36_lipid.prm                                          ;# Lipids
parameters              ${dir_ff}/par_all36_carb.prm                                           ;# Carbohydrates
parameters              ${dir_ff}/par_all36_cgenff.prm                                         ;# Cgenff
parameters              ${dir_ff}/par_all36_na.prm                                             ;# Nucleic

# Additional parameters for water/ions and non-canonical residues
parameters             ${dir_ff}/toppar_water_ions_namd.update.str                             ;# Required for Water and ions
parameters             ${dir_ff}/toppar_all36_lipid_cholesterol.str                            ;# Required for Cholesterol
parameters             ${dir_ff}/toppar_all36_lipid_sphingo.str                                ;# Required for SM Lipids
parameters             ${dir_ff}/toppar_all36_carb_glycolipid.str                              ;# Required for Glycolipids
parameters             ${dir_ff}/toppar_all36_lipid_inositol.str                               ;# Required for PI
parameters             ${dir_ff}/toppar_all36_lipid_miscellaneous.str                          ;# Required for BMGP
parameters             ${dir_ff}/toppar_all36_lipid_cardiolipin.str                            ;# Required for TLCL
parameters             ${dir_ff}/toppar_all36_lipid_ether.str                                  ;# Required for ethers

#############################################
# PERIODIC BOUNDARY CONDITIONS (PBC / CELL) #
#############################################
# Source:
#   Copy/paste values from box_size.txt.

cellBasisVector1       462.953219845 0 0
cellBasisVector2       0 465.952851118 0
cellBasisVector3       0 0 467.734389493
cellOrigin             0.0224990844727 -0.493003845215 0.162002563477


##########################################
# WRAPPING (KEEP SYSTEM CENTERED IN PBC) #
##########################################
# Output coordinates are typically written relative to the input coordinates.
# Wrapping ensures molecules remain within the central unit cell on output.

wrapWater              on                        ;# Wrap water molecules only
wrapAll                on                        ;# Wrap all bonded clusters


###################################
# NONBONDED / INTEGRATOR SETTINGS #
###################################

# Exclusions and 1-4 scaling (CHARMM convention)
exclude                scaled1-4
1-4scaling             1.0

# Cutoffs (Å)
cutoff                 12.0         ;# Local interaction cutoff
switching              on           ;# Smooth switching for electrostatics and vdW
switchdist             10.0         ;# Switching distance (cutoff - 2 Å)
pairlistdist           13.5         ;# Pairlist distance

margin                 4

# Integration (fs)
timestep               1.0          ;# timestep size (fs)
rigidBonds             all          ;# Required for 2 fs timestep with SHAKE on
nonbondedFreq          1
fullElectFrequency     3

# Neighbor list update period:
# Must be a multiple of fullElectFrequency
stepspercycle          21


################################################
## PME (FULL SYSTEM PERIODIC ELECTROSTATICS) ###
################################################

PME                    on
PMEInterpOrder         8
PMEGridSpacing         2.1


#############################################
# TEMPERATURE CONTROL (LANGEVIN THERMOSTAT) #
#############################################

langevin               on                          ;# Enable Langevin dynamics
langevinDamping        5                           ;# gamma (1/ps)
langevinTemp           $temp
langevinHydrogen       off                         ;# Do not thermostat hydrogens

###########################
### HARMONIC RESTRAINTS ###
###########################
# Harmonic constraints are active in STEP-2.
# consAtomListFile provides per-atom force constants or selection indices.
# constraintScaling scales the provided constraint forces globally.

constraints            on
consAtomListFile       ../STEP-1_A/index_water_lipid_heads_A.dat
constraintScaling      10.0


#############################################################
## PROTOCOL / EXECUTION SCRIPT                             ##
#############################################################

# Equilibration / MD segment for STEP-2
run                    $eq_numsteps

