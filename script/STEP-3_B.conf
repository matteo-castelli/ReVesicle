#############################
### ReVesicle - STEP-3_B  ###
#############################
# Purpose:
#   Gradually release harmonic constraints applied to water after the STEP-2 melting step. 
#   This is done by decreasing constraintScaling in stages (4 -> 2 -> 0), with short runs at each stage.

# Restart prefix from STEP-2_B (must have: .coor, .vel, .xsc)
set inpname            ../STEP-2_B/STEP-2_B.restart

# Output prefix for STEP-3_B (NAMD will generate STEP-3_B.* outputs)
set outname            STEP-3_B

# CHARMM36m (or CHARMM36*) parameter directory
set dir_ff             ../../CHARMM36m

# Trajectory output stridei: 50000 steps = 100 ps (timestep = 2 fs)
set dcdfreq            50000 

# Energy / pressure print frequency (stdout)
set logfreq            10080

# Print wall-clock timing info every N steps
outputTiming           10080

# Short run length (used for constraintScaling = 4 and 2)
set eq_numsteps        147000             

# Long run length (used for constraintScaling = 0)
set eq_numsteps_long   367500

# Target temperature (K)
set temp               310

#############################################################
## ADJUSTABLE PARAMETERS (SYSTEM INPUT / RESTART / OUTPUT) ##
#############################################################

# Flag for mesoscale system (use together with .js.inter)
useCompressedPsf       on

# Structure definition (compressed)
structure              ../STEP-1_B/STEP-1_B_empty_holes.js.inter

# Output prefix
outputName             ${outname}

# Restart block:
# This step continues from STEP-2_B outputs (restart files).
binCoordinates         $inpname.coor
binVelocities          $inpname.vel
extendedSystem         $inpname.xsc

# Start simulation from step 0
firsttimestep          0

# Set frequency of output (restart, DCD, xst)
restartfreq            $dcdfreq
dcdfreq                $dcdfreq
xstFreq                $dcdfreq

# Set frequency of output energies
outputEnergies         $logfreq
outputPressure         $logfreq

##############################################################
### LARGE SCALE SYSTEM PERFORMANCE / MEMORY OPTIMIZED NAMD ###
##############################################################
# Notes:
#   These options are aimed at large systems to reduce memory pressure and/or
#   improve scaling on large core counts. Keep them consistent within a project.

# Pairlists can consume large memory on big systems. This sets a threshold:
# only enable pairlists above a given processor count.
pairlistMinProcs       128

# Pencil decomposition for PME: set 1 for minimal decomposition by default.
pmepencils             1

# PME processors: uses one pencil per node by default.
pmeprocessors          [numNodes]

# Load balancing:
#   "none" disables load balancing (useful if load balancing overhead is large).
ldBalancer             none

# FFTW planning:
#   Use FFTW rules-of-thumb to reduce startup time.
FFTWEstimate           yes

# Parallel I/O settings
numinputprocs          50
numoutputprocs         50

# Topology decomposition tweaks (legacy scaling settings)
twoAwayX               no
twoAwayY               no
twoAwayZ               no

# Pressure barrier synchronization (often used only at extreme scale)
langevinPistonBarrier  off

# References
# Additional information on reducing memory usage may be found at http://www.ks.uiuc.edu/Research/namd/wiki/index.cgi?NamdMemoryReduction
# NAMD Wiki: NamdPerformanceTuning https://www.ks.uiuc.edu/Research/namd/wiki/?NamdPerformanceTuning


##############################################
# Simulation Parameters # CHARMM Force Field #
##############################################

paraTypeCharmm         on

# Base CHARMM parameter files
parameters              ${dir_ff}/par_all36m_prot.prm                                          ;# Protein
parameters              ${dir_ff}/par_all36_lipid.prm                                          ;# Lipids
parameters              ${dir_ff}/par_all36_carb.prm                                           ;# Carbohydrates
parameters              ${dir_ff}/par_all36_cgenff.prm                                         ;# Cgenff
parameters              ${dir_ff}/par_all36_na.prm                                             ;# Nucleic

# Additional parameters for water/ions and non-canonical residues
parameters             ${dir_ff}/toppar_water_ions_namd.update.str                             ;# Required for Water and ions
parameters             ${dir_ff}/toppar_all36_lipid_cholesterol.str                            ;# Required for Cholesterol
parameters             ${dir_ff}/toppar_all36_lipid_sphingo.str                                ;# Required for SM Lipids
parameters             ${dir_ff}/toppar_all36_carb_glycolipid.str                              ;# Required for Glycolipids
parameters             ${dir_ff}/toppar_all36_lipid_inositol.str                               ;# Required for PI
parameters             ${dir_ff}/toppar_all36_lipid_miscellaneous.str                          ;# Required for BMGP
parameters             ${dir_ff}/toppar_all36_lipid_cardiolipin.str                            ;# Required for TLCL
parameters             ${dir_ff}/toppar_all36_lipid_ether.str                                  ;# Required for ethers

##########################################
# WRAPPING (KEEP SYSTEM CENTERED IN PBC) #
##########################################
# Output coordinates are typically written relative to the input coordinates.
# Wrapping ensures molecules remain within the central unit cell on output.

wrapWater              on                            ;# Wrap water molecules only
wrapAll                on                            ;# Wrap all bonded clusters


###################################
# NONBONDED / INTEGRATOR SETTINGS #
###################################

exclude                scaled1-4
1-4scaling             1.0

cutoff                 12.0         ;# Local interaction cutoff (Å)
switching              on           ;# Smooth switching for electrostatics and vdW
switchdist             10.0         ;# Switching distance (cutoff - 2 Å)
pairlistdist           13.5         ;# Pairlist distance

margin                 4

timestep               2.0          ;# timestep size (fs)
rigidBonds             all          ;# Required for 2 fs timestep with SHAKE
nonbondedFreq          1
fullElectFrequency     3

# Neighbor list update period:
# Must be a multiple of fullElectFrequency
stepspercycle          21


####################################################
## PME (FULL SYSTEM PERIODIC ELECTROSTATICS)     ###
####################################################

PME                    on
PMEInterpOrder         8
PMEGridSpacing         2.1


#############################################
# TEMPERATURE CONTROL (LANGEVIN THERMOSTAT) #
#############################################

langevin               on
langevinDamping        5
langevinTemp           $temp
langevinHydrogen       off


###########################
### HARMONIC RESTRAINTS ###
###########################
# Harmonic constraints remain enabled, but constraintScaling is decreased
# progressively in the loop below to release the water constraints.

constraints            on
consAtomListFile       ../STEP-1_B/index_water_B.dat


#############################################################
## PROTOCOL / EXECUTION SCRIPT                             ##
#############################################################

# Water release schedule:
#   scale = 4  -> run eq_numsteps
#   scale = 2  -> run eq_numsteps
#   scale = 0  -> run eq_numsteps_long
#
# NOTE: The loop is written explicitly (kept identical) for clarity and reproducibility.
for {set scale 4} {$scale >=0} {incr scale -2} {

  constraintScaling $scale

  if {$scale ==4} {
        run $eq_numsteps
  }
  if {$scale ==2} {
        run $eq_numsteps
  }
  if {$scale ==0} {
        run $eq_numsteps_long
  }
}
